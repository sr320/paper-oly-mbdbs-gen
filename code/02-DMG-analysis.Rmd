---
title: "02-DMG-analysis"
author: "Laura H Spencer"
date: "1/30/2020"
output: html_document
---

In this notebook I identify differentially methylated genes (DMGs) between two Olympia oyster populations, Hood Canal and South Sound. First I prepare my data to be in the correct format / shape, then test for DMGs using a binomial GLM. The genes are also annotated using a gene feature file and BEDtools, and biological functions associated with GO terms are visualized with [REVIGO](http://revigo.irb.hr/). 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load libraries 

```{r, message=FALSE, warning=FALSE, results=FALSE}
list.of.packages <- c("tidyverse", "reshape2","dplyr", "tidyr", "readr", "stringr", "plotly", "car", "Pstat", "clipr") #add new libraries here 
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

# Load all libraries 
lapply(list.of.packages, FUN = function(X) {
  do.call("require", list(X)) 
})
```

### Load filtered methylation data object with sample info which was created in the notebook "01-methylkit" 

```{r}
load(here::here("analyses", "methylation-filtered", "R-objects", "meth_filter_reshaped")) 
head(meth_filter_reshaped) 
```

### Binomial GLMs to test for differentially methylated genes regions. 

#### Add columns for organization / filtering: 
-- gene = contig number + start/end locus  
-- group = sample number + gene  
-- population = HC for Hood Canal, or SS for South Sound  

```{r}
meth_filter_genes_2kbslop <- 
  read_delim(file = here::here("analyses", "methylation-filtered", "meth_filter_gene.2kbslop.tab"), delim = "\t", col_names = c(colnames(meth_filter_reshaped[-10]), "population", "contig_gene", "source_gene", "feature_gene", "start_gene_2kb", "end_gene_2kb", "unknown1_gene", "strand_gene", "unknown2_gene", "notes_gene")) %>%
  mutate(gene=paste(contig_gene, start_gene_2kb, end_gene_2kb, sep="_")) %>%
  mutate(group=paste(sample, gene, sep="_")) 
```

### Here is the number of genes that are represented in our methylation data set: 

```{r}
length(unique(meth_filter_genes_2kbslop$gene)) 
View(meth_filter_genes_2kbslop)
```

### Filter for genes with **at minimum 5 methylated loci**

```{r}
min.filt_2kbslop <- dplyr::count(meth_filter_genes_2kbslop, vars = c(group))
newdata <- min.filt_2kbslop[which(min.filt_2kbslop$n > 4), ]
sub_meth_table_2kbslop <- meth_filter_genes_2kbslop[meth_filter_genes_2kbslop$group %in% newdata$vars,]
save(sub_meth_table_2kbslop, file="../analyses/DMGs/R-objects/sub_meth_table_2kbslop")
```

```{r}
head(sub_meth_table_2kbslop)
```

### Here is the number of genes that remain after filtering for those with 5 or more methylated loci within each gene region:

```{r}
length(unique(sub_meth_table_2kbslop$gene))  
```

### Run GLM to test for differences among population for each gene individually 
Note: this script was created by Hollie Putnam ([GM.Rmd](https://raw.githubusercontent.com/hputnam/Geoduck_Meth/master/RAnalysis/Scripts/GM.Rmd)); there are minor revisions below. I retained some commented out lines (notably-testing for position w/n gene, such as intron & exon) in case we want to include those as factors in the future. 

```{r}
# create data frame to stored results
results_2kbslop <- data.frame()

gs <- unique(sub_meth_table_2kbslop$gene)

#first subset the unique dataframes and second run the GLMs
for(i in 1:length(gs)){
  
  #subset the dataframe gene by gene
  sub_meth_table_2kbslop1 <- subset(sub_meth_table_2kbslop, gene ==gs[i])
  
  # fit glm position model
  fit <- glm(matrix(c(numCs, numTs), ncol=2) ~ as.factor(population) + (1|sample), 
             data=sub_meth_table_2kbslop1, family=binomial)
  a <- anova(fit, test="Chisq")
  
  # capture summary stats to data frame
  df <- data.frame(sub_meth_table_2kbslop1[c("population", "sample", "contig_gene", "start_gene_2kb", "end_gene_2kb", "gene", "chr", "start", "sample", "coverage", "numCs", "numTs", "percMeth", "notes_gene")],
                   pval.treatment = a$`Pr(>Chi)`[2],
                   #pval.position = a$`Pr(>Chi)`[3], #uncomment if you want to include position of CpG within a gene
                   #pval.treatment_x_position = a$`Pr(>Chi)`[4], #uncomment if you want to include position of CpG within a gene interaction with treatment
                   stringsAsFactors = F)
  
  # bind rows of temporary data frame to the results data frame
  results_2kbslop <- rbind(results_2kbslop, df)
  
}
results_2kbslop[is.na(results_2kbslop)] <- 0
results_2kbslop$adj.pval.pop <- p.adjust(results_2kbslop$pval.treatment, method='BH')
#results_2kbslop$adj.pval.position <- p.adjust(results_2kbslop$pval.position, method='BH') #uncomment if you want to include position of CpG within a gene
#results_2kbslop$adj.pval.treatment_x_position <- p.adjust(results_2kbslop$pval.treatment_x_position, method='BH') #uncomment if you want to include position of CpG within a gene interaction with treatment
```

## Extract methylation data for DMGs 

```{r}
#save df with differentially methylated genes (this df includes methylation data per sample)
DMGs_2kbslop <- subset(results_2kbslop, adj.pval.pop < 0.05) #%>%
#  mutate(contig_gene_start=paste(contig_gene, start_gene_2kb, sep="_"))
save(DMGs_2kbslop, file="../analyses/DMGs/R-objects/DMGs_2kbslop")
```

### Edit gene and DMG stats dataframe, add uniprot accession numbers 

```{r}

# Read in O. lurida gene file that connects OLUR gene ID to uniprot accession number 
# Olurida_gene_uniprot <- read_delim(file = here::here("genome-features", "Olur_gene_UPacc.gff"), delim = "\t", col_names = c("contig", "source", "feature", "start", "end", "unknown1", "strand", "unknown2", "geneID_uniprotID")) %>%
#   separate(geneID_uniprotID, into=c("geneID","uniprotID"), sep = ";") %>% 
#   select(geneID, uniprotID)

# 
DMGresults_genes <- 
  
  # return only 1 row per gene+/-2kb 
  results_2kbslop[!duplicated(results_2kbslop$gene), c("gene", "contig_gene", "start_gene_2kb", "end_gene_2kb", "notes_gene", "pval.treatment", "adj.pval.pop")] %>%
  
  # Split giant gene "Notes" column into separate columns 
  mutate(ID=str_extract(notes_gene, "ID=(.*?);"),
       Parent=str_extract(notes_gene, "Parent=(.*?);"),
       Name=str_extract(notes_gene, "Name=(.*?);"),
       Alias=str_extract(notes_gene, "Alias=(.*?);"),
       AED=str_extract(notes_gene, "AED=(.*?);"),
       eAED=str_extract(notes_gene, "eAED=(.*?);"),
       Note=str_extract(notes_gene, "Note=(.*?);"),
       Ontology_term=str_extract(notes_gene, "Ontology_term=(.*?);"),
       Dbxref=str_extract(notes_gene, "Dbxref=(.*?);"),
       SPID=str_extract(notes_gene, "SPID=(.*?);")
       ) %>% 
  
  #remove extraneous info from Olur gene ID and Uniprot species ID ("SPID")
  mutate(Name=str_remove(Name, "Name=")) %>% mutate(Name=str_remove(Name, ";")) %>%
  mutate(SPID=str_remove(SPID, "SPID=")) %>% mutate(SPID=str_remove(SPID, ";"))
  
  #add uniprot IDs to gene dataframe 
  #left_join(Olurida_gene_uniprot, by=c("Name" = "geneID"))
```

### Here is the number of differentially methylated genes (with min. 5 loci per gene): 

```{r}
nrow(DMGresults_genes[DMGresults_genes$adj.pval.pop < 0.05,])
```

### Extract dataframes for DMG function analyses 

```{r}
# DMGs only ...

# ... in .bed format 
write_delim(DMGresults_genes[DMGresults_genes$adj.pval.pop < 0.05,][,c("contig_gene", "start_gene_2kb", "end_gene_2kb")], "../analyses/DMGs/DMGs_2kbslop.bed",  delim = '\t', col_names = FALSE)

# ... with all info, including Olurida gene ID and Uniprot accession no. (NOTE: start/stop includes +/-2kb slop)
write_delim(DMGresults_genes[DMGresults_genes$adj.pval.pop < 0.05,], 
            "../analyses/DMGs/DMGs_2kbslop_annotated.tab",  delim = '\t', col_names = FALSE)

# All genes assessed ... 

#  ... in .bed format 
write_delim(DMGresults_genes[,c("contig_gene", "start_gene_2kb", "end_gene_2kb")], "../analyses/DMGs/all-genes-assessed_2kbslop.bed",  delim = '\t', col_names = FALSE)

# ... with all info, including Olurida gene ID and Uniprot accession no. (NOTE: start/stop includes +/-2kb slop)
write_delim(DMGresults_genes, "../analyses/DMGs/all-genes-assessed_2kbslop_annotated.tab",  
            delim = '\t', col_names = FALSE)
```

## GO Enrichment Analysis in DAVID 

### Copy DMG uniprot accession numbers to clipboard, then paste into DAVID 
```{r}
write_clip(
DMGresults_genes[DMGresults_genes$adj.pval.pop < 0.05,]$SPID %>%
  na.omit() %>% as.vector())
```

### Copy uniprot accession numbers for all assessed genes to clipboard, then paste into DAVID 
```{r}
write_clip(
DMGresults_genes$SPID %>%
  na.omit() %>% as.vector())
```

## Enriched biological function, DMGs 

| Category         | Term                                                                 | Count | %    | PValue | Genes                                                                  | List Total | Pop Hits | Pop Total | Fold Enrichment | Bonferroni | Benjamini | FDR |
|------------------|----------------------------------------------------------------------|-------|------|--------|------------------------------------------------------------------------|------------|----------|-----------|-----------------|------------|-----------|-----|
| GOTERM_BP_DIRECT | GO:0007399~nervous system development                                | 9     | 5.14 | 0.011  | O15075, Q04721, Q7T163, Q8VHN7, B1AYB6, Q8WXG9, P16621, P29503, Q5SNZ0 | 155        | 17       | 756       | 2.58            | 0.9999     | 1.0       | 1.0 |
| GOTERM_BP_DIRECT | GO:0045214~sarcomere organization                                    | 4     | 2.29 | 0.060  | G4SLH0, Q2V2M9, A2ASS6, Q8WZ42                                         | 155        | 5        | 756       | 3.90            | 1.0        | 1.0       | 1.0 |
| GOTERM_BP_DIRECT | GO:1903955~positive regulation of protein targeting to mitochondrion | 4     | 2.29 | 0.060  | Q7Z6Z7, Q7TMY8, Q571F8, Q587J7                                         | 155        | 5        | 756       | 3.90            | 1.0        | 1.0       | 1.0 |
| GOTERM_BP_DIRECT | GO:0008152~metabolic process                                         | 5     | 2.86 | 0.089  | Q66PG2, P13086, O17732, Q99NB1, P07742                                 | 155        | 9        | 756       | 2.71            | 1.0        | 1.0       | 1.0 |

### Convert GO terms to GO Slim, 

Use this spreadsheet that assigns each GO Term to a GO Slim: http://owl.fish.washington.edu/halfshell/bu-alanine-wd/17-07-20/GO-GOslim.sorted

```{r}
# Read in the GO Slim table  
GOSlim <- read_delim(here::here("resources", "GO-GOslim.sorted"), delim = '\t', col_names = FALSE) %>% 
  setNames(c("GO", "term", "slim", "category")) %>% 
  mutate_at(vars(category, slim), as.factor)

GO.enriched.DMG <- read_delim(here::here("analyses", "DMGs", "Enriched-BioFunc-DMGs.txt"), delim = '\t', col_names = TRUE) %>% 
   separate(Term, into=c("GO", "term"), remove=TRUE,sep = "~") %>% 
   left_join(GOSlim, by=c("GO", "term")) #add slim 
```

### The 9 genes represented in the "Nervous system development" GO term 

| ID     | Gene Name                                       | Species                 |
|--------|-------------------------------------------------|-------------------------|
| P16621 | Leukocyte-antigen-related-like(Lar)             | Drosophila melanogaster |
| Q8WXG9 | adhesion G protein-coupled receptor V1(ADGRV1)  | Homo sapiens            |
| Q8VHN7 | adhesion G protein-coupled receptor V1(Adgrv1)  | Mus musculus            |
| Q5SNZ0 | coiled coil domain containing 88A(Ccdc88a)      | Mus musculus            |
| O15075 | doublecortin like kinase 1(DCLK1)               | Homo sapiens            |
| Q7T163 | kinase D-interacting substrate 220b(kidins220b) | Danio rerio             |
| B1AYB6 | methyl-CpG binding domain protein 5(Mbd5)       | Mus musculus            |
| P29503 | neuralized(neur)                                | Drosophila melanogaster |
| Q04721 | notch 2(NOTCH2)                                 | Homo sapiens            |

### The 4 genes represented in the "Sarcomere organization" GO term 

| ID     | Gene Name                                    | Species                |
|--------|----------------------------------------------|------------------------|
| G4SLH0 | Titin homolog(ttn-1)                         | Caenorhabditis elegans |
| Q2V2M9 | formin homology 2 domain containing 3(FHOD3) | Homo sapiens           |
| Q8WZ42 | titin(TTN)                                   | Homo sapiens           |
| A2ASS6 | titin(Ttn)                                   | Mus musculus           |

### The 4 genes represented in the "positive regulation of protein targeting to mitochondrion" GO term 

| ID     | Gene Name                                                                 | Species      |
|--------|---------------------------------------------------------------------------|--------------|
| Q7TMY8 | HECT, UBA and WWE domain containing 1(Huwe1)                              | Mus musculus |
| Q7Z6Z7 | HECT, UBA and WWE domain containing 1, E3 ubiquitin protein ligase(HUWE1) | Homo sapiens |
| Q571F8 | glutaminase 2 (liver, mitochondrial)(Gls2)                                | Mus musculus |
| Q587J7 | tudor domain containing 12(TDRD12)                                        | Homo sapiens |

### The 5 genes represented in the "metabolic process" GO term 

| ID     | Gene Name                                              | Species                |
|--------|--------------------------------------------------------|------------------------|
| O17732 | PYruvate Carboxylase(pyc-1)                            | Caenorhabditis elegans |
| Q99NB1 | acyl-CoA synthetase short-chain family member 1(Acss1) | Mus musculus           |
| Q66PG2 | like-glycosyltransferase(large)                        | Danio rerio            |
| P07742 | ribonucleotide reductase M1(Rrm1)                      | Mus musculus           |
| P13086 | succinate-CoA ligase, alpha subunit(Suclg1)            | Rattus norvegicus      |

### Here is the full list of genes that were differentially methylated  

| UNIPROT_ACCESSION | Name                                                                                                     | Species                        |
|-------------------|----------------------------------------------------------------------------------------------------------|--------------------------------|
| A0MGZ7            | heparan sulfate 6-O-sulfotransferase 3b(hs6st3b)                                                         | Danio rerio                    |
| Q9HCD6            | tetratricopeptide repeat, ankyrin repeat and coiled-coil containing 2(TANC2)                             | Homo sapiens                   |
| Q66PG2            | like-glycosyltransferase(large)                                                                          | Danio rerio                    |
| D3YWJ0            | nuclear GTPase, germinal center associated(Nuggc)                                                        | Mus musculus                   |
| Q9FLQ7            | actin binding protein(AT5G07740)                                                                         | Arabidopsis thaliana           |
| Q0P5G1            | tonsoku-like, DNA repair protein(TONSL)                                                                  | Bos taurus                     |
| Q6UWH6            | testis expressed 261(TEX261)                                                                             | Homo sapiens                   |
| Q9W0T1            | Enhancer of bithorax(E(bx))                                                                              | Drosophila melanogaster        |
| Q9UMZ2            | synergin gamma(SYNRG)                                                                                    | Homo sapiens                   |
| Q03145            | Eph receptor A2(Epha2)                                                                                   | Mus musculus                   |
| Q7T163            | kinase D-interacting substrate 220b(kidins220b)                                                          | Danio rerio                    |
| Q14315            | filamin C(FLNC)                                                                                          | Homo sapiens                   |
| A5D7H2            | striatin 3(STRN3)                                                                                        | Bos taurus                     |
| Q06A37            | chromodomain helicase DNA binding protein 7(CHD7)                                                        | Gallus gallus                  |
| O95477            | ATP binding cassette subfamily A member 1(ABCA1)                                                         | Homo sapiens                   |
| O15014            | zinc finger protein 609(ZNF609)                                                                          | Homo sapiens                   |
| O08774            | regulator of G-protein signaling 12(Rgs12)                                                               | Rattus norvegicus              |
| Q6INA9            | SET domain, bifurcated 1 L homeolog(setdb1.L)                                                            | Xenopus laevis                 |
| Q03254            | protein serine/threonine phosphatase(FCP1)                                                               | Saccharomyces cerevisiae S288C |
| P59280            | kelch-like 8(Klhl8)                                                                                      | Mus musculus                   |
| Q8NC51            | SERPINE1 mRNA binding protein 1(SERBP1)                                                                  | Homo sapiens                   |
| Q6XP49            | GLIS family zinc finger 3(Glis3)                                                                         | Mus musculus                   |
| O88281            | multiple EGF-like-domains 6(Megf6)                                                                       | Rattus norvegicus              |
| Q9UPZ6            | thrombospondin type 1 domain containing 7A(THSD7A)                                                       | Homo sapiens                   |
| Q96L91            | E1A binding protein p400(EP400)                                                                          | Homo sapiens                   |
| Q7ZYZ6            | discs, large (Drosophila) homolog-associated protein 1a(dlgap1a)                                         | Danio rerio                    |
| Q96AY4            | tetratricopeptide repeat domain 28(TTC28)                                                                | Homo sapiens                   |
| Q62371            | discoidin domain receptor family, member 2(Ddr2)                                                         | Mus musculus                   |
| Q32L77            | chromosome 8 open reading frame, human C9orf135(C8H9orf135)                                              | Bos taurus                     |
| A3KMZ6            | COX11 cytochrome c oxidase assembly homolog (yeast)(COX11)                                               | Bos taurus                     |
| P20241            | Neuroglian(Nrg)                                                                                          | Drosophila melanogaster        |
| Q96QT6            | PHD finger protein 12(PHF12)                                                                             | Homo sapiens                   |
| Q2T9T9            | F-box and WD repeat domain containing 9(FBXW9)                                                           | Bos taurus                     |
| Q8NE09            | regulator of G-protein signaling 22(RGS22)                                                               | Homo sapiens                   |
| Q00420            | GA repeat binding protein, beta 1(Gabpb1)                                                                | Mus musculus                   |
| Q80TY5            | vacuolar protein sorting 13B(Vps13b)                                                                     | Mus musculus                   |
| Q8BZ20            | poly (ADP-ribose) polymerase family, member 12(Parp12)                                                   | Mus musculus                   |
| B2GUN4            | KIAA0430(kiaa0430)                                                                                       | Xenopus tropicalis             |
| Q09JY9            | shroom family member 2(shroom2)                                                                          | Xenopus tropicalis             |
| Q9BV44            | THUMP domain containing 3(THUMPD3)                                                                       | Homo sapiens                   |
| Q6GLJ1            | BTB (POZ) domain containing 17 S homeolog(btbd17.S)                                                      | Xenopus laevis                 |
| O55131            | septin 7(Sept7)                                                                                          | Mus musculus                   |
| Q00174            | Laminin A(LanA)                                                                                          | Drosophila melanogaster        |
| Q3UGM2            | NIMA (never in mitosis gene a)- related kinase 10(Nek10)                                                 | Mus musculus                   |
| Q5F477            | lipid droplet associated hydrolase(LDAH)                                                                 | Gallus gallus                  |
| Q2V2M9            | formin homology 2 domain containing 3(FHOD3)                                                             | Homo sapiens                   |
| P13221            | glutamic-oxaloacetic transaminase 1(Got1)                                                                | Rattus norvegicus              |
| Q9HC84            | mucin 5B, oligomeric mucus/gel-forming(MUC5B)                                                            | Homo sapiens                   |
| Q5XF04            | Exostosin family protein(AT2G31990)                                                                      | Arabidopsis thaliana           |
| Q9UPR3            | SMG5, nonsense mediated mRNA decay factor(SMG5)                                                          | Homo sapiens                   |
| Q8K4L3            | supervillin(Svil)                                                                                        | Mus musculus                   |
| Q9Y2B1            | transmembrane protein 5(TMEM5)                                                                           | Homo sapiens                   |
| Q5GH73            | XK related 6(XKR6)                                                                                       | Homo sapiens                   |
| Q8WXG9            | adhesion G protein-coupled receptor V1(ADGRV1)                                                           | Homo sapiens                   |
| Q8VIJ5            | meningioma expressed antigen 5 (hyaluronidase)(Mgea5)                                                    | Rattus norvegicus              |
| Q9I7F7            | Activated Cdc42 kinase-like(Ack-like)                                                                    | Drosophila melanogaster        |
| Q9UKJ3            | G-patch domain containing 8(GPATCH8)                                                                     | Homo sapiens                   |
| Q7Z6Z7            | HECT, UBA and WWE domain containing 1, E3 ubiquitin protein ligase(HUWE1)                                | Homo sapiens                   |
| Q9BUJ2            | heterogeneous nuclear ribonucleoprotein U like 1(HNRNPUL1)                                               | Homo sapiens                   |
| Q7Z442            | polycystin 1 like 2 (gene/pseudogene)(PKD1L2)                                                            | Homo sapiens                   |
| P59511            | a disintegrin-like and metallopeptidase (reprolysin type) with thrombospondin type 1 motif, 20(Adamts20) | Mus musculus                   |
| Q9UL36            | zinc finger protein 236(ZNF236)                                                                          | Homo sapiens                   |
| Q8NI27            | THO complex 2(THOC2)                                                                                     | Homo sapiens                   |
| P36993            | protein phosphatase 1B, magnesium dependent, beta isoform(Ppm1b)                                         | Mus musculus                   |
| Q3UZV7            | RIKEN cDNA 9330182L06 gene(9330182L06Rik)                                                                | Mus musculus                   |
| P28191            | Tyrosine-protein phosphatase 1(ptp-1)                                                                    | Caenorhabditis elegans         |
| Q8VHG2            | angiomotin(Amot)                                                                                         | Mus musculus                   |
| Q69ZS7            | Hbs1-like (S. cerevisiae)(Hbs1l)                                                                         | Mus musculus                   |
| Q9JIS1            | regulating synaptic membrane exocytosis 2(Rims2)                                                         | Rattus norvegicus              |
| Q03059            | choline acetyltransferase(Chat)                                                                          | Mus musculus                   |
| Q8WZ42            | titin(TTN)                                                                                               | Homo sapiens                   |
| P13406            | FYN proto-oncogene, Src family tyrosine kinase L homeolog(fyn.L)                                         | Xenopus laevis                 |
| Q8IW19            | aprataxin and PNKP like factor(APLF)                                                                     | Homo sapiens                   |
| Q60636            | PR domain containing 1, with ZNF domain(Prdm1)                                                           | Mus musculus                   |
| Q0V989            | coiled-coil domain containing 85C(ccdc85c)                                                               | Xenopus tropicalis             |
| Q96GM8            | target of EGR1, member 1 (nuclear)(TOE1)                                                                 | Homo sapiens                   |
| Q5XGG2            | TruB pseudouridine (psi) synthase family member 2(trub2)                                                 | Xenopus tropicalis             |
| O61491            | Flotillin 1(Flo1)                                                                                        | Drosophila melanogaster        |
| Q9HCE9            | anoctamin 8(ANO8)                                                                                        | Homo sapiens                   |
| A2ASS6            | titin(Ttn)                                                                                               | Mus musculus                   |
| Q8NBD8            | transmembrane protein 229B(TMEM229B)                                                                     | Homo sapiens                   |
| P08183            | ATP binding cassette subfamily B member 1(ABCB1)                                                         | Homo sapiens                   |
| Q3UF64            | ring finger protein, transmembrane 2(Rnft2)                                                              | Mus musculus                   |
| P29503            | neuralized(neur)                                                                                         | Drosophila melanogaster        |
| Q28C33            | TBC1 domain family member 30(tbc1d30)                                                                    | Xenopus tropicalis             |
| Q9ESM0            | inositol hexakisphosphate kinase 1(Ip6k1)                                                                | Rattus norvegicus              |
| Q99NB1            | acyl-CoA synthetase short-chain family member 1(Acss1)                                                   | Mus musculus                   |
| P19137            | laminin, alpha 1(Lama1)                                                                                  | Mus musculus                   |
| Q8IYR2            | SET and MYND domain containing 4(SMYD4)                                                                  | Homo sapiens                   |
| Q571F8            | glutaminase 2 (liver, mitochondrial)(Gls2)                                                               | Mus musculus                   |
| Q5U249            | AT-hook containing transcription factor 1 L homeolog(ahctf1.L)                                           | Xenopus laevis                 |
| Q96K62            | zinc finger and BTB domain containing 45(ZBTB45)                                                         | Homo sapiens                   |
| Q6ZVT6            | chromosome 3 open reading frame 67(C3orf67)                                                              | Homo sapiens                   |
| Q5SNZ0            | coiled coil domain containing 88A(Ccdc88a)                                                               | Mus musculus                   |
| Q6ZNA1            | zinc finger protein 836(ZNF836)                                                                          | Homo sapiens                   |
| Q63648            | neurofibromin 2(Nf2)                                                                                     | Rattus norvegicus              |
| Q7TMY8            | HECT, UBA and WWE domain containing 1(Huwe1)                                                             | Mus musculus                   |
| Q14517            | FAT atypical cadherin 1(FAT1)                                                                            | Homo sapiens                   |
| O57415            | ras responsive element binding protein 1(RREB1)                                                          | Gallus gallus                  |
| P35555            | fibrillin 1(FBN1)                                                                                        | Homo sapiens                   |
| Q9NU22            | midasin AAA ATPase 1(MDN1)                                                                               | Homo sapiens                   |
| Q5G270            | protease, serine 12(PRSS12)                                                                              | Gorilla gorilla                |
| P51892            | ligase I, DNA, ATP-dependent S homeolog(lig1.S)                                                          | Xenopus laevis                 |
| Q6GQR8            | zinc finger protein 329(Zfp329)                                                                          | Mus musculus                   |
| Q8TCU4            | ALMS1, centrosome and basal body associated protein(ALMS1)                                               | Homo sapiens                   |
| O46385            | supervillin(SVIL)                                                                                        | Bos taurus                     |
| Q8WVM0            | transcription factor B1, mitochondrial(TFB1M)                                                            | Homo sapiens                   |
| Q6INP9            | breast cancer anti-estrogen resistance 3 L homeolog(bcar3.L)                                             | Xenopus laevis                 |
| O17732            | PYruvate Carboxylase(pyc-1)                                                                              | Caenorhabditis elegans         |
| Q96NE9            | FERM domain containing 6(FRMD6)                                                                          | Homo sapiens                   |
| O00237            | ring finger protein 103(RNF103)                                                                          | Homo sapiens                   |
| P13086            | succinate-CoA ligase, alpha subunit(Suclg1)                                                              | Rattus norvegicus              |
| P07742            | ribonucleotide reductase M1(Rrm1)                                                                        | Mus musculus                   |
| O15013            | Rho guanine nucleotide exchange factor 10(ARHGEF10)                                                      | Homo sapiens                   |
| Q63470            | dual specificity tyrosine phosphorylation regulated kinase 1A(Dyrk1a)                                    | Rattus norvegicus              |
| Q0P4S5            | jade family PHD finger 3(jade3)                                                                          | Xenopus tropicalis             |
| Q9EQ60            | calcium voltage-gated channel subunit alpha1 H(Cacna1h)                                                  | Rattus norvegicus              |
| Q6DFF9            | mitogen-activated protein kinase binding protein 1 L homeolog(mapkbp1.L)                                 | Xenopus laevis                 |
| Q6ZQQ6            | WD repeat domain 87(WDR87)                                                                               | Homo sapiens                   |
| Q68CP9            | AT-rich interaction domain 2(ARID2)                                                                      | Homo sapiens                   |
| Q8MT80            | CG45068 gene product from transcript CG45068-RA(CG45068)                                                 | Drosophila melanogaster        |
| Q9QXL2            | kinesin family member 21A(Kif21a)                                                                        | Mus musculus                   |
| F1MRW8            | ring finger protein 169(RNF169)                                                                          | Bos taurus                     |
| B1AYB6            | methyl-CpG binding domain protein 5(Mbd5)                                                                | Mus musculus                   |
| Q96N11            | chromosome 7 open reading frame 26(C7orf26)                                                              | Homo sapiens                   |
| P16621            | Leukocyte-antigen-related-like(Lar)                                                                      | Drosophila melanogaster        |
| Q2EMV9            | poly (ADP-ribose) polymerase family, member 14(Parp14)                                                   | Mus musculus                   |
| Q12986            | nuclear transcription factor, X-box binding 1(NFX1)                                                      | Homo sapiens                   |
| Q56A24            | kelch-like family member 24(Klhl24)                                                                      | Rattus norvegicus              |
| Q9TZM3            | Leucine-rich repeat serine/threonine-protein kinase 1(lrk-1)                                             | Caenorhabditis elegans         |
| Q9H0F5            | ring finger protein 38(RNF38)                                                                            | Homo sapiens                   |
| Q8VHN7            | adhesion G protein-coupled receptor V1(Adgrv1)                                                           | Mus musculus                   |
| A2A791            | zinc finger, MYM-type 4(Zmym4)                                                                           | Mus musculus                   |
| Q8K2Z4            | non-SMC condensin I complex, subunit D2(Ncapd2)                                                          | Mus musculus                   |
| Q8BFY9            | transportin 1(Tnpo1)                                                                                     | Mus musculus                   |
| A4QNN3            | ubiquitin specific peptidase 30(usp30)                                                                   | Xenopus tropicalis             |
| Q5ZLG9            | WD repeat domain 59(WDR59)                                                                               | Gallus gallus                  |
| Q6VNB8            | WD repeat and FYVE domain containing 3(Wdfy3)                                                            | Mus musculus                   |
| Q9C0D2            | centrosomal protein 295(CEP295)                                                                          | Homo sapiens                   |
| Q9VT28            | furry(fry)                                                                                               | Drosophila melanogaster        |
| Q05941            | cholinergic receptor nicotinic alpha 7 subunit(Chrna7)                                                   | Rattus norvegicus              |
| O16277            | Putative histone H1.6(hil-6)                                                                             | Caenorhabditis elegans         |
| Q5U2N3            | phosphatidylinositol transfer protein, membrane-associated 1(Pitpnm1)                                    | Rattus norvegicus              |
| O18973            | RAB guanine nucleotide exchange factor 1(RABGEF1)                                                        | Bos taurus                     |
| P51592            | hyperplastic discs(hyd)                                                                                  | Drosophila melanogaster        |
| G4SLH0            | Titin homolog(ttn-1)                                                                                     | Caenorhabditis elegans         |
| P84060            | dystrobrevin, beta(Dtnb)                                                                                 | Rattus norvegicus              |
| P55094            | nuclear receptor subfamily 2, group C, member 2(Nr2c2)                                                   | Rattus norvegicus              |
| Q7KHG2            | CG9397 gene product from transcript CG9397-RI(jing)                                                      | Drosophila melanogaster        |
| Q96DR7            | Rho guanine nucleotide exchange factor 26(ARHGEF26)                                                      | Homo sapiens                   |
| P31689            | DnaJ heat shock protein family (Hsp40) member A1(DNAJA1)                                                 | Homo sapiens                   |
| Q9ULT8            | HECT domain E3 ubiquitin protein ligase 1(HECTD1)                                                        | Homo sapiens                   |
| E9PVA8            | GCN1 general control of amino-acid synthesis 1-like 1 (yeast)(Gcn1l1)                                    | Mus musculus                   |
| Q9P2D8            | unc-79 homolog (C. elegans)(UNC79)                                                                       | Homo sapiens                   |
| P06795            | ATP-binding cassette, sub-family B (MDR/TAP), member 1B(Abcb1b)                                          | Mus musculus                   |
| Q6NS45            | coiled-coil domain containing 66(Ccdc66)                                                                 | Mus musculus                   |
| O57683            | splicing factor 3b subunit 1 S homeolog(sf3b1.S)                                                         | Xenopus laevis                 |
| Q3UTY6            | thrombospondin, type I, domain containing 4(Thsd4)                                                       | Mus musculus                   |
| Q92805            | golgin A1(GOLGA1)                                                                                        | Homo sapiens                   |
| O15075            | doublecortin like kinase 1(DCLK1)                                                                        | Homo sapiens                   |
| A4IF63            | tripartite motif containing 2(TRIM2)                                                                     | Bos taurus                     |
| O95980            | reversion inducing cysteine rich protein with kazal motifs(RECK)                                         | Homo sapiens                   |
| Q13439            | golgin A4(GOLGA4)                                                                                        | Homo sapiens                   |
| Q9HAR2            | adhesion G protein-coupled receptor L3(ADGRL3)                                                           | Homo sapiens                   |
| Q503Q1            | spermatogenesis associated 18(spata18)                                                                   | Danio rerio                    |
| Q5ZKG2            | bromodomain containing 7(BRD7)                                                                           | Gallus gallus                  |
| Q04721            | notch 2(NOTCH2)                                                                                          | Homo sapiens                   |
| D3ZQG6            | tripartite motif-containing 2(Trim2)                                                                     | Rattus norvegicus              |
| Q9H0C1            | zinc finger MYND-type containing 12(ZMYND12)                                                             | Homo sapiens                   |
| G5EBU4            | Zinc finger E-box-binding homeobox protein zag-1(zag-1)                                                  | Caenorhabditis elegans         |
| Q96JH7            | valosin containing protein interacting protein 1(VCPIP1)                                                 | Homo sapiens                   |
| Q00341            | high density lipoprotein binding protein(HDLBP)                                                          | Homo sapiens                   |
| O35501            | heat shock protein family A (Hsp70) member 9(Hspa9)                                                      | Cricetulus griseus             |
| P52292            | karyopherin subunit alpha 2(KPNA2)                                                                       | Homo sapiens                   |
| Q587J7            | tudor domain containing 12(TDRD12)                                                                       | Homo sapiens                   |
|                   | P40821                                                                                                   |                                |
|                   | Q9U639                                                                                                   |                                |
|                   | Q4UMH6                                                                                                   |                                |
|                   | B3EWZ6                                                                                                   |                                |
|                   | P59669                                                                                                   |                                |
|                   | P56649                                                                                                   |                                |
|                   | B3EWZ5                                                                                                   |                                |
|                   | Q04786                                                                                                   |                                |

### Barplots showing % methylation of DMGs by population 

```{r}

results_2kbslop %>%
left_join(DMGresults_genes[c("gene", "SPID", "Note")], by="gene") %>%
  filter(SPID=="Q6ZQQ6") %>% View()

# For all DMGs, calculate mean and sd percent methylation across samples by population 
results_2kbslop %>% 
  filter(adj.pval.pop < 0.05) %>%
  group_by(population, gene) %>% 
  dplyr::summarise(mean_percMeth = mean(percMeth, na.rm=TRUE), 
                   sd_percMeth=sd(percMeth, na.rm=TRUE), n_distinct(start), n()) %>% 
  #add uniprot IDs to gene dataframe 
  left_join(DMGresults_genes[c("gene", "SPID", "Note")], by="gene") %>%

# use this to call specific genes using Uniprot ID 
    filter(SPID=="Q6ZQQ6") %>%

# generate bar plot of mean % methylation +SD by population 
  ggplot(aes(x = population, y = mean_percMeth, fill = population, 
                         label=paste0(round(mean_percMeth, digits = 2), "%"))) + 
      geom_bar(stat="identity", width = 0.5) + ylim(0,118) +
      scale_y_continuous(breaks=c(0,25, 50, 75, 100)) +
      geom_pointrange(aes(ymin=mean_percMeth,
                        ymax=mean_percMeth+sd_percMeth)) +
      geom_text(size=3, vjust=-0.5, hjust=1.25) +
      theme_light() + ggtitle("Add gene name here") +
    scale_fill_manual(values=c("firebrick3","dodgerblue3"))
```


### Extract GO terms for DMGs_2kbslop and save to file 

```{r}
DMGs_2kbslop.genes.GO <- DMGresults_genes[DMGresults_genes$adj.pval.pop < 0.05,] %>% 
  mutate(Ontology_term = str_replace(Ontology_term, pattern="Ontology_term=",replacement = "")) %>%
  mutate(Ontology_term = str_replace(Ontology_term, pattern=";",replacement = "")) %>%
  separate(Ontology_term, sep=",", into=paste("GO", 1:11, sep="_")) %>%
  pivot_longer(cols=c("GO_1","GO_2","GO_3","GO_4","GO_5","GO_6","GO_7","GO_8","GO_9","GO_10","GO_11"), names_to = "GO_number", values_to = "GO_term") %>%
  dplyr::select(-GO_number) %>%
  filter(!is.na(Note) & !is.na(GO_term))

write_delim(DMGs_2kbslop.genes.GO[,c("GO_term","adj.pval.pop")], path = here::here("analyses/", "DMGs/", "DMGs_2kbslop.GO.txt"), delim = '\t', col_names = F) #write out df with just GO terms and p-adj values 
```

### Files for IGV 

Create bed files to visualze as a track of DMGs_2kbslop in IGV 

```{r}
DMGs_2kbslop.bed <- meth_filter_genes_2kbslop %>%
  filter(contig_gene %in% DMGs_2kbslop.genes$contig_gene & 
           start_gene_2kb %in% DMGs_2kbslop.genes$start_gene & 
           end_gene_2kb %in% DMGs_2kbslop.genes$end_gene) %>%
  dplyr::select(contig_gene, start_gene_2kb, end_gene_2kb, 
                unknown1_gene, strand_gene, unknown2_gene, notes_gene) %>%
  distinct(contig_gene, start_gene_2kb, end_gene_2kb)
#DMGs_2kbslop.bed <- DMGs_2kbslop.bed[!duplicated(test$contig_gene),]
readr::write_delim(DMGs_2kbslop.bed, "../analyses/DMGs/DMGs_2kbslop.bed",  delim = '\t', col_names = FALSE)
```

### Identify DMGs_2kbslop that contain DMLs 

```{bash}
intersectBed \
  -wb \
  -a "../analyses/DMGs/DMGs_2kbslop.bed" \
  -b "../analyses/DMLs/dml25.bed" \
  > "../analyses/DMGs/DMGs_2kbslop-with-DMLs.tab"
```

### Here is the number of DML loci associated with DM gene regions: 

```{bash}
wc -l "../analyses/DMGs/DMGs_2kbslop-with-DMLs.tab"
```

```{r}
dml25 <- read_delim(file = here::here("analyses", "DMLs", "dml25.bed"), delim = "\t", col_names = TRUE)

DMLs.in.DMGs_2kbslop <- 
  read_delim(file = here::here("analyses", "DMGs", "DMGs_2kbslop-with-DMLs.tab"), delim = "\t", col_names = c(colnames(DMGs_2kbslop.bed), colnames(dml25))) #%>%
  #mutate(gene=paste(contig_gene, start_gene, sep="_")) 
write.csv(DMLs.in.DMGs_2kbslop, file = "../analyses/DMGs/DMLS.in.DMGs_2kbslop.csv")
save(DMLs.in.DMGs_2kbslop, file="../analyses/DMGs/R-objects/DMLs.in.DMGs_2kbslop")

# Barplots of all DMLs also located in DMGs_2kbslop 

DMLs.in.DMGs_2kbslop.calcs <- meth_filter_reshaped %>% 
  filter(chr %in% DMLs.in.DMGs_2kbslop$contig_gene & 
           start %in% DMLs.in.DMGs_2kbslop$start_gene+1 & 
           end %in% DMLs.in.DMGs_2kbslop$end_gene-1) %>% 
  group_by(population, chr, start) %>% 
  dplyr::summarise(
    mean_percMeth = mean(percMeth, na.rm=TRUE),
    sd_percMeth=sd(percMeth, na.rm=TRUE),
    n()) 

DMLs.in.DMGs_2kbslop.calcs %>% ungroup() %>% dplyr::select(chr, start) %>% distinct()

#Plots don't work when knitted
# DMLs_in_DMGs_2kbslop_plots <- list()
# for (i in 1:nrow(DMLs.in.DMGs_2kbslop)) {
#   DMLs_in_DMGs_2kbslop_plots[[i]] <-
#     DMLs.in.DMGs_2kbslop.calcs %>%
#     filter(chr==DMLs.in.DMGs_2kbslop$contig_gene[i] &
#              start==DMLs.in.DMGs_2kbslop$start_gene[i]+1) %>%
#     ggplot(aes(x = population, y = mean_percMeth, fill = population,
#                          label=paste0(round(mean_percMeth, digits = 2), "%"))) +
#       geom_bar(stat="identity", width = 0.5) + ylim(0,110) +
#       geom_pointrange(aes(ymin=mean_percMeth,
#                         ymax=mean_percMeth+sd_percMeth)) +
#       geom_text(size=3, vjust=-0.5, hjust=1.25) +
#       theme_light() + ggtitle(paste("Contig = ", DMLs.in.DMGs_2kbslop[i, "contig_gene"], ", Locus = ",
#                                    DMLs.in.DMGs_2kbslop[i+1, "start_gene"], sep="")) +
#     scale_fill_manual(values=c("firebrick3","dodgerblue3"))
# }
# DMLs_in_DMGs_2kbslop_plots[1:6]
```

### Calculate Pst for each gene 

##### First, calculate Pst of average % methylation within genes and +/- 2kb. Only look genes that have **at minimum 5 methylated loci** (this was done in a previous chunk). I need the % methylation data for each of the gene regions, so I'll first create that dataframe. 

```{r}
# How many gene regions are there after filtering for those with 5 methylated loci? 
sub_meth_table_2kbslop %>% 
       distinct(gene) %>%
  nrow()

head(sub_meth_table_2kbslop)
head(meth_filter_reshaped) #data frame that contains coverage and % methylation info 

# I think this filtering step doesn't account for the 2kb +/- start and stop 
perc_meth_genes_2kbslop <- sub_meth_table_2kbslop %>% 
   group_by(population, sample, contig_gene, start_gene_2kb, end_gene_2kb) %>%
   dplyr::summarise(
    mean_percMeth = mean(percMeth, na.rm=TRUE),
    sd_percMeth=sd(percMeth, na.rm=TRUE),
    n())  

# check to make sure % methylation is calculated separately for each sample and gene region 
perc_meth_genes_2kbslop %>% filter(contig_gene=="Contig0", start_gene_2kb==10497, end_gene_2kb==95068) %>%
  ggplot(aes(x=sample, y=mean_percMeth)) + geom_bar(stat="identity")

# How many unique gene regions? 
perc_meth_genes_2kbslop %>% 
       ungroup() %>% 
  dplyr::select(contig_gene, start_gene_2kb, end_gene_2kb) %>%
       distinct(contig_gene, start_gene_2kb, end_gene_2kb) %>%
  nrow()

# Reshape data. Need to have one row per sample, one column with the population, and separate columns with each gene region with % methylation. 
perc_meth_genes_2kbslop_wide <- perc_meth_genes_2kbslop %>% 
  ungroup() %>%
  tidyr::unite("gene_region", c("contig_gene", "start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE) %>%
  dplyr::select(population, sample, gene_region, mean_percMeth) %>%
  spread(gene_region, mean_percMeth) %>%
  tibble::column_to_rownames(var = "sample")

head(perc_meth_genes_2kbslop_wide[1:4]) #confirm correct format 
ncol(perc_meth_genes_2kbslop_wide) #1394 gene regions 
```

### Run Pst 

```{r}
#Now run the following line and it will provide Pst estimates for every gene.
genes_2kbslop_5loci_Pst <- Pst(perc_meth_genes_2kbslop_wide)

# Check out Pst distribution 
hist(genes_2kbslop_5loci_Pst$Pst_Values)
summary(genes_2kbslop_5loci_Pst$Pst_Values)
nrow(genes_2kbslop_5loci_Pst)

# format of dataframe that I will save 
head(genes_2kbslop_5loci_Pst %>% separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE))

# Write out Pst results 
write.table(genes_2kbslop_5loci_Pst %>% separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE), file = here::here("analyses", "DMGs", "Pst_gene_2kbslop_5loci.tab"), sep = '\t', na = "NA", row.names = FALSE, col.names = TRUE)

head(genes_2kbslop_5loci_Pst %>% 
  separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE) %>%
  filter(Pst_Values>0.5))
```

#### Merge DMG list with Pst values 

```{r}

#Merge # (gene region list+Pst values) with (gene region list + adjusted p-values (<0.05 indicates significant)) 

genes_2kbslop_Pst_DMGpvalue <- merge(x=genes_2kbslop_5loci_Pst,  
      y=results_2kbslop[!duplicated(results_2kbslop$gene), c("contig_gene", "start_gene_2kb", "end_gene_2kb", "notes_gene", "gene", "adj.pval.pop")],
      by.x="Quant_Varia", 
      by.y="gene")
save(genes_2kbslop_Pst_DMGpvalue, file = "../analyses/DMGs/R-objects/genes_2kbslop_Pst_DMGpvalue")

# Assess relationship between Pst values and P-adjusted for DMG regions 
hist(genes_2kbslop_Pst_DMGpvalue$Pst_Values^0.5)
hist(genes_2kbslop_Pst_DMGpvalue$adj.pval.pop)
summary(lm(Pst_Values^.5 ~ adj.pval.pop, data=genes_2kbslop_Pst_DMGpvalue))

library(ggpmisc)
formula <- genes_2kbslop_Pst_DMGpvalue$adj.pval.pop ~ genes_2kbslop_Pst_DMGpvalue$Pst_Values

ggplot(genes_2kbslop_Pst_DMGpvalue, aes(x=Pst_Values, y=adj.pval.pop)) +
  geom_point(aes(colour = cut(adj.pval.pop, c(-Inf, 0.05, Inf)))) + 
  scale_color_manual(name = "DMG region significance",
                     values = c("(-Inf,0.05]" = "red",
                                  "(0.05, Inf]" = "black"),
                     labels = c("significant", "non-significant")) +
  ylab("P-Adjusted from diff. methylated gene region analysis") +
  xlab("Pst values, gene regions") + 
  ggtitle("Gene Region P-Adjusted ~ Pst") +
  geom_smooth(method = "lm", se = F) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               label.x.npc = "right", label.y.npc = 0.85,
               formula = formula, parse = TRUE, size = 3, col="blue") +
  ylim(c(0,1))
```



##### Second, calculate Pst of average % methylation only within genes. Only look genes that have **at minimum 5 methylated loci** (this was done in a previous chunk). I need the % methylation data for each of the gene regions, so I'll first create that dataframe. 

```{r}
# Read in data file with gene bodies that contain methylated loci 
meth_filter_genes <- 
  read_delim(file = here::here("analyses", "methylation-filtered", "meth_filter_gene.tab"), delim = "\t", col_names = c(colnames(meth_filter_reshaped[-10]), "population", "contig_gene", "source_gene", "feature_gene", "start_gene", "end_gene", "unknown1_gene", "strand_gene", "unknown2_gene", "notes_gene")) %>%
  mutate(gene=paste(contig_gene, start_gene, end_gene, sep="_")) %>%
  mutate(group=paste(sample, gene, sep="_"))

# Filter for gene bodies that have 5 or more methylated loci 
min.filt_genes <- dplyr::count(meth_filter_genes, vars = c(group))
newdata <- min.filt_genes[which(min.filt_genes$n > 4), ]
sub_meth_table <- meth_filter_genes[meth_filter_genes$group %in% newdata$vars,]

# Calculate average % methylation within gene bodies by sample 
perc_meth_genes <- sub_meth_table %>% 
   group_by(population, sample, contig_gene, start_gene, end_gene) %>%
   dplyr::summarise(
    mean_percMeth = mean(percMeth, na.rm=TRUE),
    sd_percMeth=sd(percMeth, na.rm=TRUE),
    n())  

# check to make sure % methylation is calculated separately for each sample and gene region 
perc_meth_genes %>% filter(contig_gene=="Contig0", start_gene==12497, end_gene==93068) %>%
  ggplot(aes(x=sample, y=mean_percMeth)) + geom_bar(stat="identity")

# Reshape data. Need to have one row per sample, one column with the population, and separate columns with each gene region with % methylation. 
perc_meth_genes_wide <- perc_meth_genes %>% 
  ungroup() %>%
  tidyr::unite("gene_region", c("contig_gene", "start_gene", "end_gene"), sep = "_", remove = FALSE) %>%
  dplyr::select(population, sample, gene_region, mean_percMeth) %>%
  spread(gene_region, mean_percMeth) %>%
  column_to_rownames(var = "sample")
head(perc_meth_genes_wide[1:4]) #confirm correct format 

#Now run the following line and it will provide Pst estimates for every gene.
genes_Pst <- Pst(perc_meth_genes_wide)

hist(genes_Pst$Pst_Values)
summary(genes_Pst$Pst_Values)
nrow(genes_Pst)

# Write out Pst results 
write.table(genes_Pst %>% separate(Quant_Varia, into=c("contig_gene","start_gene", "end_gene"), sep = "_", remove = FALSE), file = here::here("analyses", "DMGs", "Pst_gene.tab"), sep = '\t', na = "NA", row.names = FALSE, col.names = TRUE)
```

### Heatmap of DMGs 

```{r}
DMG.ratios <- DMGs_2kbslop %>% 
  #mutate(contig_gene_start=paste(contig_gene, start_gene_2kb, sep="_")) %>%
  group_by(population, gene) %>%
  summarise(mean_percentMeth = mean(percMeth, na.rm = TRUE)) %>% 
  dcast(gene ~ population) %>% 
  mutate(ratio_HC.SS = HC/SS) %>%
  arrange(ratio_HC.SS) #in this ratio column, values <1 = HC hypomethylated, values >1 = SS hypomethylated 

ggplot(DMGs_2kbslop, aes(sample, gene, fill= percMeth)) + xlab("Sample") + geom_tile(na.rm = T) +
  scale_y_discrete(limits=(DMG.ratios[order(DMG.ratios$ratio_HC.SS),]$gene)) + 
  #scale_fill_viridis(discrete=FALSE) 
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) + 
  scale_fill_distiller(palette = "YlGnBu", direction = 1)
  #scale_fill_gradient(low="gray5", high="white")
```

## Calculate Pst for all genes represented in our methylation data 

#### First, how many gene regions are there? 

```{r}
meth_filter_genes_2kbslop %>% 
       distinct(gene) %>%
  nrow()
```

#### I need the % methylation data for each of the gene regions, so I'll first create that dataframe. 

```{r}
perc_meth_genes_2kbslop <- meth_filter_genes_2kbslop %>% 
   group_by(population, sample, contig_gene, start_gene_2kb, end_gene_2kb) %>%
   dplyr::summarise(
    mean_percMeth = mean(percMeth, na.rm=TRUE),
    sd_percMeth=sd(percMeth, na.rm=TRUE),
    n())  

# check a couple loci to make sure % methylation is calculated separately for each sample and gene region 
perc_meth_genes_2kbslop %>% filter(contig_gene=="Contig0", start_gene_2kb==10497, end_gene_2kb==95068) %>%
  ggplot(aes(x=sample, y=mean_percMeth)) + geom_bar(stat="identity")

perc_meth_genes_2kbslop %>% filter(contig_gene=="Contig1050", start_gene_2kb==4735, end_gene_2kb==27978) %>%
  ggplot(aes(x=sample, y=mean_percMeth)) + geom_bar(stat="identity")

# Reshape data. Need to have one row per sample, one column with the population, and separate columns with each gene region with % methylation. 
perc_meth_genes_2kbslop_wide <- perc_meth_genes_2kbslop %>% 
  ungroup() %>%
  tidyr::unite("gene_region", c("contig_gene", "start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE) %>%
  dplyr::select(population, sample, gene_region, mean_percMeth) %>%
  spread(gene_region, mean_percMeth) %>%
  tibble::column_to_rownames(var = "sample")

head(perc_meth_genes_2kbslop_wide[1:4]) #confirm correct format 
ncol(perc_meth_genes_2kbslop_wide) # 3754 gene regions 
```

### Run Pst 

```{r}
#Now run the following line and it will provide Pst estimates for every gene.
genes_2kbslop_Pst <- Pst(perc_meth_genes_2kbslop_wide)

# This object contains Pst values for all genes that contain methylation data.  
save(genes_2kbslop_Pst, file = "../analyses/methylation-filtered/R-objects/genes_2kbslop_Pst") #save object to file

# Check out Pst distribution & summary statistics 
hist(genes_2kbslop_Pst$Pst_Values)
mean(genes_2kbslop_Pst$Pst_Values) 
min(genes_2kbslop_Pst$Pst_Values) 
nrow(genes_2kbslop_Pst) #

# format of dataframe that I will save 
head(genes_2kbslop_Pst %>% separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE))

# Write out Pst results 
write.table(genes_2kbslop_Pst %>% separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE), file = here::here("analyses", "DMGs", "Pst_gene_2kbslop.tab"), sep = '\t', na = "NA", row.names = FALSE, col.names = TRUE)

head(genes_2kbslop_Pst %>% 
  separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE) %>%
  filter(Pst_Values>0.5))
```

## Examine methylation patters by gene location 

```{r}
# Methylation data within genes 
meth_filter_genes 

# Methylation data within genes +/- 2kb 
meth_filter_genes_2kbslop 
```

## Calculate the relative location of methylation sites across a gene 

(distance from start of gene / length of gene) 
= (Methylated locus - start_gene) / (end_gene - start_gene)

```{r}
meth_filter_genes <- meth_filter_genes %>% 
  mutate(gen_location = ((start-start_gene)/(end_gene-start_gene)))

# Histogram showing frequency of methylation data across gene (relative location)
meth_filter_genes %>% 
  group_by(gene, gen_location, population) %>% 
  summarise(mean_meth=mean(percMeth)) %>%
  ggplot(., aes(x=gen_location)) +
  stat_bin(bins=150, col="gray30", fill="lavenderblush3") +
  xlab("Relative location along gene") + 
  ylab("Frequency of methylation data") + 
  ggtitle("Methylation frequency relative to gene location") +
  theme_minimal()

# Percent methylation across gene 
meth_filter_genes$gen_location_round <- round(meth_filter_genes$gen_location, digits=2)

meth_filter_genes %>% 
  ungroup() %>%
  group_by(gen_location_round) %>% 
  summarise(mean_meth=mean(percMeth, na.rm=TRUE), sd_meth=sd(percMeth, na.rm=TRUE)) %>%
  ggplot(., aes(x=gen_location_round, y=mean_meth)) +
  geom_bar(stat="identity", col="gray30", fill="lavenderblush3") +
  # geom_errorbar(aes(ymin=mean_meth-sd_meth, ymax=mean_meth+sd_meth), width=.02,
  #                position=position_dodge(.9), ) +
  scale_y_continuous(limits = c(0, 100)) +
  xlab("Relative location along gene") +
  ylab("Mean % methylation") +
  ggtitle("% methylation by relative gene location") +
  theme_minimal()

# Plot methylation variance by gene location  
meth_filter_genes %>% 
  ungroup() %>%
  group_by(gen_location_round) %>% 
  summarise(var_meth=var(percMeth, na.rm=TRUE)) %>%
  ggplot(., aes(x=gen_location_round, y=var_meth)) +
  geom_bar(stat="identity", col="gray30", fill="lavenderblush3") +
  xlab("Relative location along gene") +
  ylab("Variance in % methylation") +
  ggtitle("Variance in % methylation by relative gene location") +
  theme_minimal()
```

```{r}
meth_filter_genes_2kbslop <- meth_filter_genes_2kbslop %>% 
  mutate(gen_location = ((start-start_gene_2kb)/(end_gene_2kb-start_gene_2kb)))

hist(meth_filter_genes_2kbslop$gen_location, breaks = 100, main= "Frequency of methylation data by relative genome location")

# Histogram showing frequency of methylation data across genes with 2kb flanking regions (relative location)
meth_filter_genes_2kbslop %>% 
  group_by(gene, gen_location, population) %>% 
  summarise(mean_meth=mean(percMeth)) %>%
  ggplot(., aes(x=gen_location)) +
  stat_bin(bins=200, col="gray30", fill="lavenderblush3") +
  xlab("Relative location along gene") + 
  ylab("Frequency of methylation data") + 
  ggtitle("Methylation frequency along genes +/- 2kb flanks") +
  theme_minimal()

```

Plot methylation Pst values (mean) calculated at the loci level across a gene 

```{r}
load("../analyses/methylation-filtered/R-objects/perc.meth.Pst.done")

# split loci location info (contig, start, end) into three columns, merge with methylation by gene object, drop loci w/o Pst values, and plot 

perc.meth.Pst.done %>% 
  separate(Quant_Varia, c("chr", "start", "end"), "\\.") %>%
  mutate(start=as.numeric(start), end=as.numeric(end)) %>%
  right_join(., 
            meth_filter_genes %>% 
              dplyr::select(chr, start, end, start_gene, end_gene, 
                     gen_location, gen_location_round)) %>%
  drop_na(Pst_Values) %>% 
  #mutate(gen_location_round=as.factor(gen_location_round)) %>%
  ungroup() %>%
  group_by(gen_location_round) %>% 
  summarise(mean_Pst=mean(Pst_Values, na.rm=TRUE), sd_Pst=sd(Pst_Values, na.rm=TRUE)) %>%
  ggplot(., aes(x=gen_location_round, y=mean_Pst)) +
  geom_bar(stat="identity", col="gray30", fill="lavenderblush3") +
  # geom_errorbar(aes(ymin=mean_Pst, ymax=mean_Pst+sd_Pst), width=.01,
  #               position=position_dodge(.9), ) +
  xlab("Relative location along gene") +
  ylab("Methylation Pst") +
  ggtitle("Mean Methylation Pst (comparing population) by relative gene location") +
  theme_minimal() #+
#  theme(axis.text.x=element_blank())
```



# Additional optional analyses 

----------------------------------------------------------------------

### DMG analysis with relaxed loci settings 

#### Filter for genes with **at minimum 4 methylated loci**

```{r}
newdata_4loci <- min.filt_2kbslop[which(min.filt_2kbslop$n > 3), ]
sub_meth_table_2kbslop_4loci <- meth_filter_genes_2kbslop[meth_filter_genes_2kbslop$group %in% newdata_4loci$vars,]
save(sub_meth_table_2kbslop_4loci, file="../analyses/DMGs/R-objects/sub_meth_table_2kbslop_4loci")
```

### Here is the number of genes that remain after filtering for those with 4 or more methylated loci within each gene region:

```{r}
length(unique(sub_meth_table_2kbslop_4loci$gene))  
```

### Run GLM to test for differences among population for each gene individually 

Note: this script was created by Hollie Putnam ([GM.Rmd](https://raw.githubusercontent.com/hputnam/Geoduck_Meth/master/RAnalysis/Scripts/GM.Rmd)); there are minor revisions below. I retained some commented out lines (notably-testing for position w/n gene, such as intron & exon) in case we want to include those as factors in the future. 

```{r}
# create data frame to stored results
results_2kbslop_4loci <- data.frame()

gs <- unique(sub_meth_table_2kbslop_4loci$gene)

#first subset the unique dataframes and second run the GLMs
for(i in 1:length(gs)){
  
  #subset the dataframe gene by gene
  sub_meth_table_2kbslop1 <- subset(sub_meth_table_2kbslop_4loci, gene ==gs[i])
  
  # fit glm position model
  fit <- glm(matrix(c(numCs, numTs), ncol=2) ~ as.factor(population) + (1|sample), 
             data=sub_meth_table_2kbslop1, family=binomial)
  a <- anova(fit, test="Chisq")
  
  # capture summary stats to data frame
  df <- data.frame(sub_meth_table_2kbslop1[c("population", "sample", "contig_gene", "start_gene_2kb", "end_gene_2kb", "gene", "chr", "start", "sample", "coverage", "numCs", "numTs", "percMeth", "notes_gene")],
                   pval.treatment = a$`Pr(>Chi)`[2],
                   #pval.position = a$`Pr(>Chi)`[3], #uncomment if you want to include position of CpG within a gene
                   #pval.treatment_x_position = a$`Pr(>Chi)`[4], #uncomment if you want to include position of CpG within a gene interaction with treatment
                   stringsAsFactors = F)
  
  # bind rows of temporary data frame to the results data frame
  results_2kbslop_4loci <- rbind(results_2kbslop_4loci, df)
}

results_2kbslop_4loci[is.na(results_2kbslop_4loci)] <- 0
results_2kbslop_4loci$adj.pval.pop <- p.adjust(results_2kbslop_4loci$pval.treatment, method='BH')
#results_2kbslop$adj.pval.position <- p.adjust(results_2kbslop$pval.position, method='BH') #uncomment if you want to include position of CpG within a gene
#results_2kbslop$adj.pval.treatment_x_position <- p.adjust(results_2kbslop$pval.treatment_x_position, method='BH') #uncomment if you want to include position of CpG within a gene interaction with treatment
```

### Edit gene and DMG stats dataframe, add uniprot accession numbers 

```{r}
# Read in O. lurida gene file that connects OLUR gene ID to uniprot accession number 
# Olurida_gene_uniprot <- read_delim(file = here::here("genome-features", "Olur_gene_UPacc.gff"), delim = "\t", col_names = c("contig", "source", "feature", "start", "end", "unknown1", "strand", "unknown2", "geneID_uniprotID")) %>%
#   separate(geneID_uniprotID, into=c("geneID","uniprotID"), sep = ";") %>% 
#   select(geneID, uniprotID)

# 
DMGresults_genes_4loci <- 
  
  # return only 1 row per gene+/-2kb 
  results_2kbslop_4loci[!duplicated(results_2kbslop_4loci$gene), c("contig_gene", "start_gene_2kb", "end_gene_2kb", "notes_gene", "pval.treatment", "adj.pval.pop")] %>%
  
  # Split giant gene "Notes" column into separate columns 
  mutate(ID=str_extract(notes_gene, "ID=(.*?);"),
       Parent=str_extract(notes_gene, "Parent=(.*?);"),
       Name=str_extract(notes_gene, "Name=(.*?);"),
       Alias=str_extract(notes_gene, "Alias=(.*?);"),
       AED=str_extract(notes_gene, "AED=(.*?);"),
       eAED=str_extract(notes_gene, "eAED=(.*?);"),
       Note=str_extract(notes_gene, "Note=(.*?);"),
       Ontology_term=str_extract(notes_gene, "Ontology_term=(.*?);"),
       Dbxref=str_extract(notes_gene, "Dbxref=(.*?);")
       ) %>% 
  
  #remove extraneous info from Olur gene ID
  mutate(Name=str_remove(Name, "Name=")) %>% mutate(Name=str_remove(Name, ";")) %>% 
  
  #add uniprot IDs to gene dataframe 
  #left_join(Olurida_gene_uniprot, by=c("Name" = "geneID"))
```

### Here is the number of differentially methylated genes (with min. 5 loci per gene): 

```{r}
nrow(DMGresults_genes_4loci[DMGresults_genes_4loci$adj.pval.pop < 0.05,])
```

## GO Enrichment Analysis in DAVID 

### Copy DMG uniprot accession numbers to clipboard, then paste into DAVID 
```{r}
write_clip(
DMGresults_genes_4loci[DMGresults_genes_4loci$adj.pval.pop < 0.05,]$uniprotID %>%
  na.omit() %>% as.vector())
```

### Copy uniprot accession numbers for all assessed genes to clipboard, then paste into DAVID 
```{r}
write_clip(
DMGresults_genes_4loci$uniprotID %>%
  na.omit() %>% as.vector())
```

### Extract only genes that were differentially methylated (4 loci min) (p-adj < 0.05):

```{r}
# #save df with differentially methylated genes 
# DMGs_2kbslop_4loci <- subset(results_2kbslop_4loci, adj.pval.pop < 0.05) #%>%
# #  mutate(contig_gene_start=paste(contig_gene, start_gene_2kb, sep="_"))
# 
# DMGs_2kbslop_4loci.genes <- DMGs_2kbslop_4loci[!duplicated(DMGs_2kbslop_4loci$gene), c("contig_gene", "start_gene_2kb", "end_gene_2kb", "notes_gene", "pval.treatment", "adj.pval.pop")]
# save(DMGs_2kbslop_4loci, file="../analyses/DMGs/R-objects/DMGs_2kbslop_4loci")
```

## Extract methylation data for DMGs 

```{r}
# #save df with differentially methylated genes (this df includes methylation data per sample)
# DMGs_2kbslop <- subset(results_2kbslop, adj.pval.pop < 0.05) #%>%
# #  mutate(contig_gene_start=paste(contig_gene, start_gene_2kb, sep="_"))
# save(DMGs_2kbslop, file="../analyses/DMGs/R-objects/DMGs_2kbslop")
```

### Extract GO terms for DMGs_2kbslop_4loci and save to file 

```{r}
# split gene data in "notes_gene" column into separate columns 
DMGs_2kbslop_4loci.genes <- DMGs_2kbslop_4loci.genes %>%
  mutate(ID=str_extract(notes_gene, "ID=(.*?);"),
       Parent=str_extract(notes_gene, "Parent=(.*?);"),
       Name=str_extract(notes_gene, "Name=(.*?);"),
       Alias=str_extract(notes_gene, "Alias=(.*?);"),
       AED=str_extract(notes_gene, "AED=(.*?);"),
       eAED=str_extract(notes_gene, "eAED=(.*?);"),
       Note=str_extract(notes_gene, "Note=(.*?);"),
       Ontology_term=str_extract(notes_gene, "Ontology_term=(.*?);"),
       Dbxref=str_extract(notes_gene, "Dbxref=(.*?);")
       )
write_csv(DMGs_2kbslop_4loci.genes, path = here::here("analyses", "DMGs", "DMGs_2kbslop_4loci.genes.csv"))

#Extract GO terms 
DMGs_2kbslop_4loci.genes.GO <- DMGs_2kbslop_4loci.genes %>%
  mutate(Ontology_term = str_replace(Ontology_term, pattern="Ontology_term=",replacement = "")) %>%
  mutate(Ontology_term = str_replace(Ontology_term, pattern=";",replacement = "")) %>%
  separate(Ontology_term, sep=",", into=paste("GO", 1:11, sep="_")) %>%
  pivot_longer(cols=c("GO_1","GO_2","GO_3","GO_4","GO_5","GO_6","GO_7","GO_8","GO_9","GO_10","GO_11"), names_to = "GO_number", values_to = "GO_term") %>%
  dplyr::select(-GO_number) %>%
  filter(!is.na(Note) & !is.na(GO_term))

write_delim(DMGs_2kbslop_4loci.genes.GO[,c("GO_term","adj.pval.pop")], path = here::here("analyses/", "DMGs/", "DMGs_2kbslop_4loci.GO.txt"), delim = '\t', col_names = F) #write out df with just GO terms and p-adj values 
```

### Calculate Pst for each gene (min 4 loci per gene)

##### First, calculate Pst of average % methylation within genes and +/- 2kb. Only look genes that have **at minimum 4 methylated loci** (this was done in a previous chunk). I need the % methylation data for each of the gene regions, so I'll first create that dataframe. 

```{r}
# How many gene regions are there after filtering for those with 4 methylated loci? 
sub_meth_table_2kbslop_4loci %>% 
       distinct(gene) %>%
  nrow()

# I think this filtering step doesn't account for the 2kb +/- start and stop 
perc_meth_genes_2kbslop_4loci <- sub_meth_table_2kbslop_4loci %>% 
   group_by(population, sample, contig_gene, start_gene_2kb, end_gene_2kb) %>%
   dplyr::summarise(
    mean_percMeth = mean(percMeth, na.rm=TRUE),
    sd_percMeth=sd(percMeth, na.rm=TRUE),
    n())  

# check to make sure % methylation is calculated separately for each sample and gene region 
perc_meth_genes_2kbslop_4loci %>% filter(contig_gene=="Contig0", start_gene_2kb==10497, end_gene_2kb==95068) %>%
  ggplot(aes(x=sample, y=mean_percMeth)) + geom_bar(stat="identity")

# How many unique gene regions? 
perc_meth_genes_2kbslop_4loci %>% 
       ungroup() %>% 
  dplyr::select(contig_gene, start_gene_2kb, end_gene_2kb) %>%
       distinct(contig_gene, start_gene_2kb, end_gene_2kb) %>%
  nrow()

# Reshape data. Need to have one row per sample, one column with the population, and separate columns with each gene region with % methylation. 
perc_meth_genes_2kbslop_4loci_wide <- perc_meth_genes_2kbslop_4loci %>% 
  ungroup() %>%
  tidyr::unite("gene_region", c("contig_gene", "start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE) %>%
  dplyr::select(population, sample, gene_region, mean_percMeth) %>%
  spread(gene_region, mean_percMeth) %>%
  tibble::column_to_rownames(var = "sample")

head(perc_meth_genes_2kbslop_4loci_wide[1:4]) #confirm correct format 
ncol(perc_meth_genes_2kbslop_4loci_wide) #1724 gene regions 
```

### Run Pst 

```{r}
#Now run the following line and it will provide Pst estimates for every gene.
genes_2kbslop_4loci_Pst <- Pst(perc_meth_genes_2kbslop_4loci_wide)

# Check out Pst distribution 
hist(genes_2kbslop_4loci_Pst$Pst_Values)
summary(genes_2kbslop_4loci_Pst$Pst_Values)
nrow(genes_2kbslop_4loci_Pst)

# format of dataframe that I will save 
head(genes_2kbslop_4loci_Pst %>% separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE))

# Write out Pst results 
write.table(genes_2kbslop_4loci_Pst %>% separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE), file = here::here("analyses", "DMGs", "Pst_gene_2kbslop_4loci.tab"), sep = '\t', na = "NA", row.names = FALSE, col.names = TRUE)

head(genes_2kbslop_4loci_Pst %>% 
  separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE) %>%
  filter(Pst_Values>0.5))
```

----------------------------------------------------------------------

### DMG analysis with relaxed loci settings 

#### Filter for genes with **at minimum 3 methylated loci**

```{r}
newdata_3loci <- min.filt_2kbslop[which(min.filt_2kbslop$n > 2), ]
sub_meth_table_2kbslop_3loci <- meth_filter_genes_2kbslop[meth_filter_genes_2kbslop$group %in% newdata_3loci$vars,]
save(sub_meth_table_2kbslop_3loci, file="../analyses/DMGs/R-objects/sub_meth_table_2kbslop_3loci")
```

### Here is the number of genes that remain after filtering for those with 4 or more methylated loci within each gene region:

```{r}
length(unique(sub_meth_table_2kbslop_3loci$gene))  
```

### Run GLM to test for differences among population for each gene individually 

Note: this script was created by Hollie Putnam ([GM.Rmd](https://raw.githubusercontent.com/hputnam/Geoduck_Meth/master/RAnalysis/Scripts/GM.Rmd)); there are minor revisions below. I retained some commented out lines (notably-testing for position w/n gene, such as intron & exon) in case we want to include those as factors in the future. 

```{r}
# create data frame to stored results
results_2kbslop_3loci <- data.frame()

gs <- unique(sub_meth_table_2kbslop_3loci$gene)

#first subset the unique dataframes and second run the GLMs
for(i in 1:length(gs)){
  
  #subset the dataframe gene by gene
  sub_meth_table_2kbslop1 <- subset(sub_meth_table_2kbslop_3loci, gene ==gs[i])
  
  # fit glm position model
  fit <- glm(matrix(c(numCs, numTs), ncol=2) ~ as.factor(population) + (1|sample), 
             data=sub_meth_table_2kbslop1, family=binomial)
  a <- anova(fit, test="Chisq")
  
  # capture summary stats to data frame
  df <- data.frame(sub_meth_table_2kbslop1[c("population", "sample", "contig_gene", "start_gene_2kb", "end_gene_2kb", "gene", "chr", "start", "sample", "coverage", "numCs", "numTs", "percMeth", "notes_gene")],
                   pval.treatment = a$`Pr(>Chi)`[2],
                   #pval.position = a$`Pr(>Chi)`[3], #uncomment if you want to include position of CpG within a gene
                   #pval.treatment_x_position = a$`Pr(>Chi)`[4], #uncomment if you want to include position of CpG within a gene interaction with treatment
                   stringsAsFactors = F)
  
  # bind rows of temporary data frame to the results data frame
  results_2kbslop_3loci <- rbind(results_2kbslop_3loci, df)
}

results_2kbslop_3loci[is.na(results_2kbslop_3loci)] <- 0
results_2kbslop_3loci$adj.pval.pop <- p.adjust(results_2kbslop_3loci$pval.treatment, method='BH')
#results_2kbslop$adj.pval.position <- p.adjust(results_2kbslop$pval.position, method='BH') #uncomment if you want to include position of CpG within a gene
#results_2kbslop$adj.pval.treatment_x_position <- p.adjust(results_2kbslop$pval.treatment_x_position, method='BH') #uncomment if you want to include position of CpG within a gene interaction with treatment
```

### Edit gene and DMG stats dataframe, add uniprot accession numbers 

```{r}
# Read in O. lurida gene file that connects OLUR gene ID to uniprot accession number 
# Olurida_gene_uniprot <- read_delim(file = here::here("genome-features", "Olur_gene_UPacc.gff"), delim = "\t", col_names = c("contig", "source", "feature", "start", "end", "unknown1", "strand", "unknown2", "geneID_uniprotID")) %>%
#   separate(geneID_uniprotID, into=c("geneID","uniprotID"), sep = ";") %>% 
#   select(geneID, uniprotID)

# 
DMGresults_genes_3loci <- 
  
  # return only 1 row per gene+/-2kb 
  results_2kbslop_3loci[!duplicated(results_2kbslop_3loci$gene), c("contig_gene", "start_gene_2kb", "end_gene_2kb", "notes_gene", "pval.treatment", "adj.pval.pop")] %>%
  
  # Split giant gene "Notes" column into separate columns 
  mutate(ID=str_extract(notes_gene, "ID=(.*?);"),
       Parent=str_extract(notes_gene, "Parent=(.*?);"),
       Name=str_extract(notes_gene, "Name=(.*?);"),
       Alias=str_extract(notes_gene, "Alias=(.*?);"),
       AED=str_extract(notes_gene, "AED=(.*?);"),
       eAED=str_extract(notes_gene, "eAED=(.*?);"),
       Note=str_extract(notes_gene, "Note=(.*?);"),
       Ontology_term=str_extract(notes_gene, "Ontology_term=(.*?);"),
       Dbxref=str_extract(notes_gene, "Dbxref=(.*?);")
       ) %>% 
  
  #remove extraneous info from Olur gene ID
  mutate(Name=str_remove(Name, "Name=")) %>% mutate(Name=str_remove(Name, ";")) %>% 
  
  #add uniprot IDs to gene dataframe 
  left_join(Olurida_gene_uniprot, by=c("Name" = "geneID"))
```

### Here is the number of differentially methylated genes (with min. 5 loci per gene): 

```{r}
nrow(DMGresults_genes_3loci[DMGresults_genes_3loci$adj.pval.pop < 0.05,])
```

## GO Enrichment Analysis in DAVID 

### Copy DMG uniprot accession numbers to clipboard, then paste into DAVID 
```{r}
write_clip(
DMGresults_genes_3loci[DMGresults_genes_3loci$adj.pval.pop < 0.05,]$uniprotID %>%
  na.omit() %>% as.vector())
```

### Copy uniprot accession numbers for all assessed genes to clipboard, then paste into DAVID 
```{r}
write_clip(
DMGresults_genes_3loci$uniprotID %>%
  na.omit() %>% as.vector())
```

### Extract only genes that were differentially methylated (3 loci min) (p-adj < 0.05):

```{r}
#save df with differentially methylated genes 
DMGs_2kbslop_3loci <- subset(results_2kbslop_3loci, adj.pval.pop < 0.05) #%>%
#  mutate(contig_gene_start=paste(contig_gene, start_gene_2kb, sep="_"))

DMGs_2kbslop_3loci.genes <- DMGs_2kbslop_3loci[!duplicated(DMGs_2kbslop_3loci$gene), c("contig_gene", "start_gene_2kb", "end_gene_2kb", "notes_gene", "pval.treatment", "adj.pval.pop")]
save(DMGs_2kbslop_3loci, file="../analyses/DMGs/R-objects/DMGs_2kbslop_3loci")
```

### Here is the number of differentially methylated genes (3 loci min): 

```{r}
length(unique(DMGs_2kbslop_3loci$gene))  
```

### Extract GO terms for DMGs_2kbslop_3loci and save to file 

```{r}
# split gene data in "notes_gene" column into separate columns 
DMGs_2kbslop_3loci.genes <- DMGs_2kbslop_3loci.genes %>%
  mutate(ID=str_extract(notes_gene, "ID=(.*?);"),
       Parent=str_extract(notes_gene, "Parent=(.*?);"),
       Name=str_extract(notes_gene, "Name=(.*?);"),
       Alias=str_extract(notes_gene, "Alias=(.*?);"),
       AED=str_extract(notes_gene, "AED=(.*?);"),
       eAED=str_extract(notes_gene, "eAED=(.*?);"),
       Note=str_extract(notes_gene, "Note=(.*?);"),
       Ontology_term=str_extract(notes_gene, "Ontology_term=(.*?);"),
       Dbxref=str_extract(notes_gene, "Dbxref=(.*?);")
       )
write_csv(DMGs_2kbslop_3loci.genes, path = here::here("analyses", "DMGs", "DMGs_2kbslop_3loci.genes.csv"))

#Extract GO terms 
DMGs_2kbslop_3loci.genes.GO <- DMGs_2kbslop_3loci.genes %>%
  mutate(Ontology_term = str_replace(Ontology_term, pattern="Ontology_term=",replacement = "")) %>%
  mutate(Ontology_term = str_replace(Ontology_term, pattern=";",replacement = "")) %>%
  separate(Ontology_term, sep=",", into=paste("GO", 1:11, sep="_")) %>%
  pivot_longer(cols=c("GO_1","GO_2","GO_3","GO_4","GO_5","GO_6","GO_7","GO_8","GO_9","GO_10","GO_11"), names_to = "GO_number", values_to = "GO_term") %>%
  dplyr::select(-GO_number) %>%
  filter(!is.na(Note) & !is.na(GO_term))

write_delim(DMGs_2kbslop_3loci.genes.GO[,c("GO_term","adj.pval.pop")], path = here::here("analyses/", "DMGs/", "DMGs_2kbslop_3loci.GO.txt"), delim = '\t', col_names = F) #write out df with just GO terms and p-adj values 
```

### Calculate Pst for each gene (min 3 loci per gene)

##### First, calculate Pst of average % methylation within genes and +/- 2kb. Only look genes that have **at minimum 3 methylated loci** (this was done in a previous chunk). I need the % methylation data for each of the gene regions, so I'll first create that dataframe. 

```{r}
# How many gene regions are there after filtering for those with 3 methylated loci? 
sub_meth_table_2kbslop_3loci %>% 
       distinct(gene) %>%
  nrow()

# I think this filtering step doesn't account for the 2kb +/- start and stop 
perc_meth_genes_2kbslop_3loci <- sub_meth_table_2kbslop_3loci %>% 
   group_by(population, sample, contig_gene, start_gene_2kb, end_gene_2kb) %>%
   dplyr::summarise(
    mean_percMeth = mean(percMeth, na.rm=TRUE),
    sd_percMeth=sd(percMeth, na.rm=TRUE),
    n())  

# check to make sure % methylation is calculated separately for each sample and gene region 
perc_meth_genes_2kbslop_3loci %>% filter(contig_gene=="Contig0", start_gene_2kb==10497, end_gene_2kb==95068) %>%
  ggplot(aes(x=sample, y=mean_percMeth)) + geom_bar(stat="identity")

# How many unique gene regions? 
perc_meth_genes_2kbslop_3loci %>% 
       ungroup() %>% 
  dplyr::select(contig_gene, start_gene_2kb, end_gene_2kb) %>%
       distinct(contig_gene, start_gene_2kb, end_gene_2kb) %>%
  nrow()

# Reshape data. Need to have one row per sample, one column with the population, and separate columns with each gene region with % methylation. 
perc_meth_genes_2kbslop_3loci_wide <- perc_meth_genes_2kbslop_3loci %>% 
  ungroup() %>%
  tidyr::unite("gene_region", c("contig_gene", "start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE) %>%
  dplyr::select(population, sample, gene_region, mean_percMeth) %>%
  spread(gene_region, mean_percMeth) %>%
  tibble::column_to_rownames(var = "sample")

head(perc_meth_genes_2kbslop_3loci_wide[1:4]) #confirm correct format 
ncol(perc_meth_genes_2kbslop_3loci_wide) #1724 gene regions 
```

### Run Pst 

```{r}
#Now run the following line and it will provide Pst estimates for every gene.
genes_2kbslop_3loci_Pst <- Pst(perc_meth_genes_2kbslop_3loci_wide)

# Check out Pst distribution 
hist(genes_2kbslop_3loci_Pst$Pst_Values)
summary(genes_2kbslop_3loci_Pst$Pst_Values)
nrow(genes_2kbslop_3loci_Pst)

# format of dataframe that I will save 
head(genes_2kbslop_3loci_Pst %>% separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE))

# Write out Pst results 
write.table(genes_2kbslop_3loci_Pst %>% separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE), file = here::here("analyses", "DMGs", "Pst_gene_2kbslop_3loci.tab"), sep = '\t', na = "NA", row.names = FALSE, col.names = TRUE)

head(genes_2kbslop_3loci_Pst %>% 
  separate(Quant_Varia, into=c("contig_gene","start_gene_2kb", "end_gene_2kb"), sep = "_", remove = FALSE) %>%
  filter(Pst_Values>0.5))
```

## Examine methylation in genes known to differ in response to environmental stressors 
These genes were examined via qPCR identified in the Heare et al. paper

```{r}
# load("../analyses/methylation-filtered/R-objects/perc.meth")
library(data.table)

x <- perc.meth %>% unlist() %>% as.data.frame() %>% rownames_to_column() %>%
  separate(col=rowname, into=c("contig", "start", "end"), sep = "\\.", remove = F) %>% select(contig, start, end) %>% mutate_at(vars(start, end), as.numeric) %>%
  #mutate(start=start-1, end=end+1) %>% 
  setDT() 

y <- read_delim(here::here("genome-features", "Heare-PCRtargets-2kslop.gff"), delim = "\t", col_names = F) %>% select(X1, X4, X5) %>% set_names(c("contig", "start", "end")) %>% setDT() %>% setkey(contig, start, end)

# Find which methylated loci are found within any of the Heare qPCR genes 
print(meth.heare <- foverlaps(x=x, y=y, type="within", nomatch =NULL))  #one gene, contains 2 methylated loci 

perc.meth %>% unlist() %>% as.data.frame() %>% rownames_to_column() %>%
  separate(col=rowname, into=c("contig", "start", "end"), sep = "\\.", remove = T) %>%
  filter(contig==unique(meth.heare$contig) & start==c(meth.heare$i.start)) %>% 
  pivot_longer(cols = -c(contig, start, end), names_to = "sample") %>% mutate_at(vars(sample), as.numeric) %>%
  mutate(population=factor(ifelse(sample < 10, 'Hood Canal', "South Sound"))) %>% 
  ggplot(aes(x=population, y=value, fill=population)) + geom_boxplot() + geom_jitter(width = .05) + facet_wrap(vars(start)) + 
  theme_minimal() + scale_fill_manual(values=c("firebrick3", "dodgerblue3")) + xlab(NULL) + ylab("% Methylated") + ggtitle("% Methylation by population\nloci in PCR gene, tth-1 (Thymosin beta)")

test <- perc.meth %>% unlist() %>% as.data.frame() %>% rownames_to_column() %>%
  separate(col=rowname, into=c("contig", "start", "end"), sep = "\\.", remove = T) %>%
  filter(contig==unique(meth.heare$contig) & start==c(meth.heare$i.start)) %>% 
  pivot_longer(cols = -c(contig, start, end), names_to = "sample") %>% mutate_at(vars(sample), as.numeric) %>%
  mutate(population=factor(ifelse(sample < 10, 'Hood Canal', "South Sound")))

# Does % methylation differ among the two populations? 
Anova(glm(value~population, data=subset(test, start==7879))) #not diff. 
Anova(glm(value~population, data=subset(test, start==9731))) #kinda diff. 
```


### old barplot code, commented out not sure if it works still 

```{r}
# ggplotly(meth_filter_genes_2kbslop %>%
#   filter(contig_gene %in% DMGs_2kbslop.genes$contig_gene & 
#            start_gene %in% DMGs_2kbslop.genes$start_gene & 
#            end_gene %in% DMGs_2kbslop.genes$end_gene) %>% 
#   group_by(population, gene) %>%
#   summarise(allCs_percent = 100*(sum(numCs)/sum(coverage)), 
#             mean_percentMeth = mean(percMeth)) %>%
#   ggplot(aes(x = population, y = mean_percentMeth, fill = population)) + geom_bar(stat="identity") + facet_wrap(~gene) + theme_light() + scale_fill_manual(values=c("firebrick3","dodgerblue3")))
# 
# #checking to make sure numCs + numTs = coverage; should be 1:1 line 
# plot(meth_filter_genes_2kbslop$numCs + meth_filter_genes_2kbslop$numTs ~ meth_filter_genes_2kbslop$coverage)  
# 
# ## Look at coverage for each DMG by population (mean % methylation across samples)
# ggplotly(meth_filter_genes_2kbslop %>%
#   filter(contig_gene %in% DMGs_2kbslop.genes$contig_gene & 
#            start_gene %in% DMGs_2kbslop.genes$start_gene & 
#            end_gene %in% DMGs_2kbslop.genes$end_gene) %>% 
#   group_by(population, gene) %>%
#   summarise(sum_cov = sum(coverage), 
#             mean_cov = mean(coverage)) %>%
#   ggplot(aes(x = population, y = mean_cov, fill = population)) + 
#     geom_bar(stat="identity") + 
#     facet_wrap(~gene) + theme_light() + scale_fill_manual(values=c("firebrick3","dodgerblue3")))
# 
# DMG_counts <- meth_filter_genes_2kbslop %>%
#   filter(contig_gene %in% DMGs_2kbslop.genes$contig_gene & 
#            start_gene %in% DMGs_2kbslop.genes$start_gene & 
#            end_gene %in% DMGs_2kbslop.genes$end_gene)
# 
# # Look at coverage for each DMG locus, by population 
# # mean % methylation across samples  
# DMG_genes_unique <- unique(DMG_counts$gene)
# for (i in 1:length(DMG_genes_unique)) {
#   temp <-  DMG_counts %>% 
#   filter(chr == "Contig22489") %>%
#   group_by(population, chr, start) %>%
#   summarise(allCs_percent = 100*(sum(numCs)/sum(coverage)), 
#             mean_percentMeth = mean(percMeth))
#     print(ggplotly(ggplot(temp, aes(x = population, y = mean_percentMeth, fill = population)) + 
#     geom_bar(stat="identity") + 
#     facet_wrap(~start) + 
#     theme_light() + ggtitle(paste("gene = ", "Contig22489", sep="")) +
#     scale_fill_manual(values=c("firebrick3","dodgerblue3"))))
#   }
```

